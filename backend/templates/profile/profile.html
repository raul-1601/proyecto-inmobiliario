{% extends "base/base.html" %}
{% load static %}

{% block content %}

<div class="container light-style flex-grow-1 container-p-y">
  <h4 class="font-weight-bold py-3 mb-4">Configuración de perfil</h4>

  <div class="card overflow-hidden">
    <div class="row no-gutters row-bordered row-border-light">
      <!-- Sidebar -->
      <div class="col-md-3 pt-0">
        <div class="list-group list-group-flush account-settings-links">
          <a class="list-group-item list-group-item-action active" data-toggle="list" href="#mi-perfil">Mi perfil</a>
          <a class="list-group-item list-group-item-action" data-toggle="list" href="#actualizar-datos">Actualizar datos y contraseña</a>

          {% if user.es_arrendador %}
            <a class="list-group-item list-group-item-action" data-toggle="list" href="#mis-propiedades">Mis propiedades</a>
            <a class="list-group-item list-group-item-action" data-toggle="list" href="#gestionar-solicitudes">Gestionar solicitudes</a>
          {% else %}
            <a class="list-group-item list-group-item-action" data-toggle="list" href="#mis-solicitudes">Mis solicitudes</a>
          {% endif %}
        </div>
      </div>

      <!-- Content -->
      <div class="col-md-9">
        <div class="tab-content">

          <!-- Sección Mi Perfil -->
          <div class="tab-pane fade active show" id="mi-perfil">
            <div class="card-body media align-items-center">
              <img src="" alt="" class="d-block ui-w-80">
              <div class="media-body ml-4">
                <h5>{{ user.username }}</h5>
                <p>{{ user.first_name }} {{ user.last_name }}</p>
                <p>{{ user.email }}</p>
                {% if user.es_arrendador %}
                  <p class="text-muted">Propiedades publicadas: {{ user.inmueble_set.count }}</p>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Sección Actualizar datos y contraseña -->
          <div class="tab-pane fade" id="actualizar-datos">
            <div class="card-body">
              <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <!-- datos editables excepto rut, nombre, apellido -->
                <div class="form-group">
                  <label class="form-label">Correo</label>
                  <input type="email" name="email" class="form-control" value="{{ user.email }}">
                </div>
                <div class="form-group">
                  <label class="form-label">Dirección</label>
                  <input type="text" name="direccion" class="form-control" value="{{ user.direccion }}">
                </div>
                <div class="form-group">
                  <label class="form-label">Comuna</label>
                  <select name="comuna" class="custom-select">
                    {% for comuna in comunas %}
                      <option value="{{ comuna.id }}" {% if user.comuna == comuna %}selected{% endif %}>{{ comuna.nombre }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Foto de perfil</label>
                  <input type="file" name="foto_perfil" class="form-control">
                </div>
                <hr>
                <h6>Cambiar contraseña</h6>
                <div class="form-group">
                  <label class="form-label">Contraseña actual</label>
                  <input type="password" name="old_password" class="form-control">
                </div>
                <div class="form-group">
                  <label class="form-label">Nueva contraseña</label>
                  <input type="password" name="new_password1" class="form-control">
                </div>
                <div class="form-group">
                  <label class="form-label">Repite nueva contraseña</label>
                  <input type="password" name="new_password2" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">Guardar cambios</button>
              </form>
            </div>
          </div>

          {% if user.es_arrendador %}
          <!-- Sección Mis Propiedades -->
          <div class="tab-pane fade" id="mis-propiedades">
            <div class="card-body">
              <h5>Mis propiedades</h5>
              <ul class="list-group">
                {% for propiedad in user.inmueble_set.all %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ propiedad.nombre }} - {{ propiedad.direccion }}
                    <a href="{% url 'inmueble_detail' propiedad.id %}" class="btn btn-sm btn-outline-primary">Ver detalle</a>
                  </li>
                {% empty %}
                  <li class="list-group-item">No tienes propiedades publicadas.</li>
                {% endfor %}
              </ul>
            </div>
          </div>

          <!-- Sección Gestionar solicitudes -->
          <div class="tab-pane fade" id="gestionar-solicitudes">
            <div class="card-body">
              <h5>Solicitudes de arriendo</h5>
              {% for inmueble in user.inmueble_set.all %}
                <h6 class="mt-3">{{ inmueble.nombre }}</h6>
                <ul class="list-group">
                  {% for solicitud in inmueble.solicitudarriendo_set.all %}
                    <li class="list-group-item">
                      {{ solicitud.usuario }} - {{ solicitud.mensaje }}
                      <form method="post" class="mt-2">
                        {% csrf_token %}
                        <select name="estado" class="custom-select">
                          <option value="pendiente" {% if solicitud.estado == "pendiente" %}selected{% endif %}>Pendiente</option>
                          <option value="aprobada" {% if solicitud.estado == "aprobada" %}selected{% endif %}>Aprobada</option>
                          <option value="rechazada" {% if solicitud.estado == "rechazada" %}selected{% endif %}>Rechazada</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-primary mt-2">Guardar</button>
                      </form>
                    </li>
                  {% empty %}
                    <li class="list-group-item">No hay solicitudes para este inmueble.</li>
                  {% endfor %}
                </ul>
              {% endfor %}
            </div>
          </div>
          {% else %}
          <!-- Sección Mis Solicitudes (arrendatario) -->
          <div class="tab-pane fade" id="mis-solicitudes">
            <div class="card-body">
              <h5>Mis solicitudes</h5>
              <ul class="list-group">
                {% for solicitud in user.solicitudarriendo_set.all %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ solicitud.inmueble.nombre }} - Estado: 
                    <span class="badge 
                      {% if solicitud.estado == 'pendiente' %}badge-warning
                      {% elif solicitud.estado == 'aprobada' %}badge-success
                      {% else %}badge-danger{% endif %}">
                      {{ solicitud.estado }}
                    </span>
                  </li>
                {% empty %}
                  <li class="list-group-item">No has realizado solicitudes de arriendo.</li>
                {% endfor %}
              </ul>
            </div>
          </div>
          {% endif %}

        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
