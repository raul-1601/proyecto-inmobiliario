{% extends "base/base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container light-style flex-grow-1 container-p-y">
  <h4 class="font-weight-bold py-3 mb-4">Configuración de perfil</h4>

  <div class="card overflow-hidden">
    <div class="row no-gutters row-bordered row-border-light">
      <!-- Sidebar -->
      <div class="col-md-3 pt-0">
        <div class="list-group list-group-flush account-settings-links">
          <a class="list-group-item list-group-item-action active" data-bs-toggle="list" href="#mi-perfil">Mi perfil</a>
          <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#actualizar-datos">Actualizar datos y contraseña</a>

          {% if user.tipo_usuario == "ARRENDADOR" %}
            <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#mis-propiedades">Mis propiedades</a>
            <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#mis-solicitudes">Solicitudes recibidas</a>
          {% else %}
            <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#mis-solicitudes">Mis solicitudes</a>
          {% endif %}
        </div>
      </div>

      <!-- Content -->
      <div class="col-md-9">
        <div class="tab-content">

          <!-- Sección Mi Perfil -->
          <div class="tab-pane fade active show" id="mi-perfil">
            <div class="card-body media align-items-center">
              {% if user.foto_perfil %}
                <img src="{{ user.foto_perfil.url }}" alt="Foto de perfil" class="d-block ui-w-80">
              {% else %}
                <img src="{% static 'default-profile.png' %}" alt="Sin foto" class="d-block ui-w-80">
              {% endif %}
              <div class="media-body ml-4">
                <h5>Nombre de usuario: {{ user.username }}</h5>
                <p>Nombre y Apellido: {{ user.first_name }} {{ user.last_name }}</p>
                <p>RUT: {{ user.rut }}</p>
                <p>Email: {{ user.email }}</p>
                <p>Dirección: {% if user.direccion %}{{ user.direccion }}{% else %}No asignada{% endif %}</p>
                <p>Comuna: {% if user.comuna %}{{ user.comuna.nombre }}{% else %}No asignada{% endif %}</p>
                <p>Región: {% if user.comuna and user.comuna.region %}{{ user.comuna.region.nombre }}{% else %}No asignada{% endif %}</p>
                {% if user.tipo_usuario == "ARRENDADOR" %}
                  <p class="text-muted">Propiedades publicadas: {{ mis_inmuebles|length }}</p>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Sección Actualizar datos y contraseña -->
          <div class="tab-pane fade" id="actualizar-datos">
            <div class="card-body">
              <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                  <label class="form-label">Correo</label>
                  <input type="email" name="email" class="form-control" value="{{ user.email }}">
                </div>
                <div class="form-group">
                  <label class="form-label">Dirección</label>
                  <input type="text" name="direccion" class="form-control" value="{{ user.direccion }}">
                </div>
                <div class="form-group">
                  <label class="form-label">Región</label>
                  <select name="region" id="region-select" class="form-select" hx-get="{% url 'cargar_comunas_ajax' %}" hx-target="#comuna-select" hx-trigger="change">
                    <option value="">Seleccione una región</option>
                    {% for region in regiones %}
                      <option value="{{ region.id }}" {% if user.comuna and user.comuna.region.id == region.id %}selected{% endif %}>{{ region.nombre }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Comuna</label>
                  <select name="comuna" id="comuna-select" class="form-select">
                    {% if user.comuna %}
                      <option value="{{ user.comuna.id }}" selected>{{ user.comuna.nombre }}</option>
                    {% else %}
                      <option value="">Seleccione una comuna</option>
                    {% endif %}
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Foto de perfil</label>
                  <input type="file" name="foto_perfil" class="form-control">
                </div>
                <hr>
                <h6>Cambiar contraseña</h6>
                <div class="form-group">
                  <label class="form-label">Contraseña actual</label>
                  <input type="password" name="old_password" class="form-control">
                </div>
                <div class="form-group">
                  <label class="form-label">Nueva contraseña</label>
                  <input type="password" name="new_password1" class="form-control">
                </div>
                <div class="form-group">
                  <label class="form-label">Repite nueva contraseña</label>
                  <input type="password" name="new_password2" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">Guardar cambios</button>
              </form>
            </div>
          </div>

          {% if user.tipo_usuario == "ARRENDADOR" %}
          <!-- Sección Mis Propiedades -->
          <div class="tab-pane fade" id="mis-propiedades">
            <div class="card-body">
              <h5>Mis propiedades</h5>
              <ul class="list-group">
                {% for propiedad in mis_inmuebles %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ propiedad.nombre }} - {{ propiedad.direccion }}
                    <a href="" class="btn btn-sm btn-outline-primary">Editar</a>
                  </li>
                {% empty %}
                  <li class="list-group-item">No tienes propiedades publicadas.</li>
                {% endfor %}
              </ul>
            </div>
          </div>
          {% endif %}

          <!-- Sección Solicitudes -->
          <div class="tab-pane fade" id="mis-solicitudes">
            <div class="card-body">
              {% if user.tipo_usuario == "ARRENDADOR" %}
                <h5>Solicitudes recibidas</h5>
                <ul class="list-group">
                  <li class="list-group-item d-flex align-items-center fw-bold">
                    <div class="d-flex gap-4 flex-grow-1">
                      <span style="min-width: 120px;">Arrendatario</span>
                      <span style="min-width: 120px;">Nombre inmueble</span>
                      <span style="min-width: 150px;">Dirección</span>
                      <span style="min-width: 100px;">Comuna</span>
                      <span style="min-width: 100px;">Región</span>
                    </div>
                    <span>Estado</span>
                  </li>
                  {% for solicitud in gestion_solicitudes %}
                    <li class="list-group-item d-flex align-items-center">
                      <div class="d-flex gap-4 flex-grow-1">
                        <span style="min-width: 120px;">{{ solicitud.arrendatario }}</span>
                        <span style="min-width: 120px;">{{ solicitud.inmueble.nombre }}</span>
                        <span style="min-width: 150px;">{{ solicitud.inmueble.direccion }}</span>
                        <span style="min-width: 100px;">{% if solicitud.inmueble.comuna %}{{ solicitud.inmueble.comuna.nombre }}{% else %}N/A{% endif %}</span>
                        <span style="min-width: 100px;">{% if solicitud.inmueble.comuna and solicitud.inmueble.comuna.region %}{{ solicitud.inmueble.comuna.region.nombre }}{% else %}N/A{% endif %}</span>
                      </div>
                      <span class="badge 
                        {% if solicitud.estado == 'PENDIENTE' %}bg-warning
                        {% elif solicitud.estado == 'APROBADA' %}bg-success
                        {% else %}bg-danger{% endif %}">
                        {{ solicitud.estado }}
                      </span>
                    </li>
                  {% empty %}
                    <li class="list-group-item">No has recibido solicitudes de arriendo.</li>
                  {% endfor %}
                </ul>
              {% else %}
                <h5>Mis solicitudes</h5>
                <ul class="list-group">
                  <li class="list-group-item d-flex align-items-center fw-bold">
                    <div class="d-flex gap-4 flex-grow-1">
                      <span style="min-width: 120px;">Nombre inmueble</span>
                      <span style="min-width: 150px;">Dirección</span>
                      <span style="min-width: 100px;">Comuna</span>
                      <span style="min-width: 100px;">Región</span>
                    </div>
                    <span>Estado</span>
                  </li>
                  {% for solicitud in mis_solicitudes %}
                    <li class="list-group-item d-flex align-items-center">
                      <div class="d-flex gap-4 flex-grow-1">
                        <span style="min-width: 120px;">{{ solicitud.inmueble.nombre }}</span>
                        <span style="min-width: 150px;">{{ solicitud.inmueble.direccion }}</span>
                        <span style="min-width: 100px;">{% if solicitud.inmueble.comuna %}{{ solicitud.inmueble.comuna.nombre }}{% else %}N/A{% endif %}</span>
                        <span style="min-width: 100px;">{% if solicitud.inmueble.comuna and solicitud.inmueble.comuna.region %}{{ solicitud.inmueble.comuna.region.nombre }}{% else %}N/A{% endif %}</span>
                      </div>
                      <span class="badge 
                        {% if solicitud.estado == 'PENDIENTE' %}bg-warning
                        {% elif solicitud.estado == 'APROBADA' %}bg-success
                        {% else %}bg-danger{% endif %}">
                        {{ solicitud.estado }}
                      </span>
                    </li>
                  {% empty %}
                    <li class="list-group-item">No has realizado solicitudes de arriendo.</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
